
name: Build and Deploy WAR app to Azure Web App - hello-world-java-app

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # âœ… IMPORTANT: set this to '.' if pom.xml is in repo root
  APP_PATH: "java-latest-code"
  ARTIFACT_NAME: "java-app"
  ARTIFACT_DIR: "artifact"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: "25"
          distribution: "temurin"
          cache: maven

      - name: Validate working directory exists
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "Listing repo root:"
          ls -la
          echo "Listing APP_PATH (${APP_PATH}):"
          ls -la "${APP_PATH}"

      - name: Build with Maven (WAR)
        run: mvn -B clean package
        working-directory: ${{ env.APP_PATH }}

      - name: Verify build output
        run: |
          echo "Target folder:"
          ls -la target || true
          echo "WAR/JAR files:"
          find target -maxdepth 2 -type f \( -name "*.war" -o -name "*.jar" \) -print || true
        working-directory: ${{ env.APP_PATH }}

      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.APP_PATH }}/target/*.war
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_DIR }}

      - name: List downloaded files
        run: ls -R "${ARTIFACT_DIR}"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: "hello-world-java-app"
          slot-name: "Production"
          package: "${{ env.ARTIFACT_DIR }}/*.war"
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_376B55C5166748239D2C0E95F3E041E0 }}
